import streamlit as st
import os
import re
from google import genai
from google.genai import types
from dotenv import load_dotenv

# Load environment variables from .env file
load_dotenv()

# Set up Gemini API key from .env file
client = genai.Client(
    api_key=os.getenv("GEMINI_API_KEY"),
)

# Long context to be used for all queries
LONG_CONTEXT = """
On March 30, 2025, the Guidance for Industry: Quality Systems Approach to Pharmaceutical CGMP Regulations, issued in September 2006 by the U.S. Department of Health and Human Services, Food and Drug Administration (FDA), through the Center for Drug Evaluation and Research (CDER), Center for Biologics Evaluation and Research (CBER), Center for Veterinary Medicine (CVM), and Office of Regulatory Affairs (ORA), with additional copies available from the Office of Training and Communication, Division of Drug Information, HFD-240, CDER, Food and Drug Administration, 5600 Fishers Lane, Rockville, MD 20857 (Tel: 301-827-4573, http://www.fda.gov/cder/guidance/index.htm), Office of Communication, Training and Manufacturers Assistance, HFM-40, CBER, Food and Drug Administration, 1401 Rockville Pike, Rockville, MD 20852-1448 (Tel: 800-835-4709 or 301-827-1800, http://www.fda.gov/cber/guidelines.htm), and Communications Staff, HFV-12, CVM, Food and Drug Administration, 7519 Standish Place, Rockville, MD 20855 (Tel: 301-827-3800, http://www.fda.gov/cvm/guidance/published.html), provides nonbinding recommendations representing the FDA’s current thinking on implementing modern quality systems and risk management approaches to meet the requirements of the Agency’s current good manufacturing practice (CGMP) regulations under 21 CFR Parts 210 and 211, developed by the Office of Compliance in CDER with cooperation from CBER, CVM, and ORA, not creating or conferring rights for or on any person, not operating to bind FDA or the public, allowing alternative approaches if they satisfy applicable statutes and regulations, advising contact with FDA staff responsible for implementation or the numbers on the title page if staff are unidentified; the document includes a Table of Contents listing I. Introduction, II. Background and Purpose (A. Background, B. Goal of the Guidance, C. Scope of the Guidance, D. Organization of this Guidance), III. CGMPs and the Concepts of Modern Quality Systems (A. Quality, B. Quality by Design and Product Development, C. Quality Risk Management, D. CAPA (Corrective and Preventive Action), E. Change Control, F. The Quality Unit, G. Six-system Inspection Model), IV. The Quality Systems Model (A. Management Responsibilities (1. Provide Leadership, 2. Structure the Organization, 3. Build Your Quality System to Meet Requirements, 4. Establish Policies, Objectives, and Plans, 5. Review the System), B. Resources (1. General Arrangements, 2. Personnel Development, 3. Facilities and Equipment, 4. Control Outsourced Operations), C. Manufacturing (1. Design, Develop, and Document Product and Processes, 2. Examine Inputs, 3. Perform and Monitor Operations, 4. Address Nonconformities), D. Evaluation Activities (1. Analyze Data for Trends, 2. Conduct Internal Audits, 3. Quality Risk Management, 4. Corrective Action, 5. Preventive Actions, 6. Promote Improvement)), V. Conclusion, Useful Reference Materials, and Glossary; Section I—Introduction states this guidance is intended to help manufacturers implementing modern quality systems and risk management approaches to meet CGMP regulations (21 CFR Parts 210 and 211), describing a comprehensive quality systems (QS) model highlighting consistency with CGMP requirements for manufacturing human and veterinary drugs, including biological drug products, explaining how such systems ensure full compliance with Parts 210 and 211, not placing new expectations or replacing CGMP requirements, advising readers to refer to Parts 210 and 211 for full compliance, noting FDA guidance documents do not establish legally enforceable responsibilities, describing the Agency’s current thinking as recommendations unless specific regulatory or statutory requirements are cited, with “should” meaning suggested or recommended but not required; Section II—Background and Purpose includes Subsection A—Background stating in August 2002 the FDA announced the Pharmaceutical CGMPs for the 21st Century Initiative to integrate quality systems and risk management into existing programs, encouraging industry adoption of modern and innovative manufacturing technologies, spurred by advances in manufacturing science and quality systems since the 1978 CGMP revision, noting many manufacturers already implement comprehensive modern quality systems and risk management, aiming to harmonize CGMPs with other non-U.S. pharmaceutical regulatory systems and FDA’s medical device quality systems regulations, supporting Critical Path Initiative objectives for efficient development of innovative medical products, with the CGMPs for the 21st Century Initiative steering committee creating a Quality System Guidance Development working group (QS working group) to compare CGMP regulations (Parts 210, 211, and 1978 Preamble) to existing quality management systems like the Drug Manufacturing Inspections Program (systems-based inspectional program), Environmental Protection Agency’s Guidance for Developing Quality Systems for Environmental Programs, ISO Quality Standards, other quality publications, and regulatory case experience, determining CGMP regulations provide flexibility but do not explicitly incorporate all modern quality management elements, differing in organization and elements but sharing underlying principles (e.g., CGMP stresses quality control, modern systems emphasize quality management, assurance, and risk tools), deciding to examine how CGMP and modern quality systems fit in today’s manufacturing world; Subsection B—Goal of the Guidance states this guidance describes a comprehensive quality systems model allowing manufacturers to support and sustain robust modern quality systems consistent with CGMP regulations, demonstrating how elements fit within CGMP requirements, leveraging CGMP flexibility for appropriate implementation, articulating the philosophy that quality should be built into the product and testing alone cannot ensure quality, serving as a bridge between 1978 regulations and current quality system understanding, issued to reduce recalls, returns, and defective products, harmonize CGMP with ISO 9000, non-U.S. pharmaceutical requirements, and FDA device regulations, enable changes to facilities, equipment, and processes without prior approval via robust quality systems and process knowledge, shorten and reduce FDA inspections, provide a framework for quality by design, continual improvement, and risk management tailored to operations, scope, process complexity, and resources; Subsection C—Scope of the Guidance states it applies to manufacturers of drug products (finished pharmaceuticals) regulated by CBER, CDER, and CVM, potentially useful for manufacturers of components (e.g., active pharmaceutical ingredients), not creating new requirements beyond CGMP or guiding FDA inspections, explaining how comprehensive quality systems achieve compliance with 21 CFR Parts 210 and 211, with QS working group findings correlating many elements to CGMP but not all, expecting compliance with CGMP regulations, with FDA inspections focused on CGMP compliance; Subsection D—Organization of this Guidance states the quality systems model in Section IV is organized into major sections (Management Responsibilities, Resources, Manufacturing Operations, Evaluation Activities) per international quality standards, discussing key elements and CGMP correlations, including detailed CGMP discussions where related, with tables listing elements and CGMP regulations at each section’s end, and a glossary; Section III—CGMPS and the Concepts of Modern Quality Systems includes Subsection A—Quality defining quality as every pharmaceutical product having established identity, strength, purity, and other characteristics ensuring safety and effectiveness, with “achieving quality” meaning attaining these characteristics; Subsection B—Quality by Design and Product Development defining quality by design as designing and developing a product and associated manufacturing processes during development to ensure consistent predefined quality at the end of manufacturing (per ICH Q8), providing with QS a framework for transferring product knowledge and process understanding from development to commercial manufacturing and post-development changes/optimization, with CGMP regulations viewed holistically incorporating quality by design; Subsection C—Quality Risk Management stating it’s a valuable QS component (per ICH Q9), guiding specifications and process parameters, assessing/mitigating risks of changes, determining discrepancy investigation and corrective action extent; Subsection D—CAPA (Corrective and Preventive Action) detailing CAPA as a CGMP concept focusing on investigating, understanding, and correcting discrepancies to prevent recurrence, including remedial corrections of identified problems, root cause analysis with corrective action to understand causes and prevent similar problems, and preventive action to avert similar potential problems; Subsection E—Change Control describing it as a CGMP concept managing change to prevent unintended consequences via the quality control unit (QCU), with major changes (e.g., altering specifications, critical attributes, bioavailability) requiring regulatory filings and prior approval (21 CFR 314.70, 514.8, 601.12), effective QS change control (planning, revising specifications/parameters/procedures) enabling continual improvement within regulations based on material variability and lifecycle knowledge; Subsection F—The Quality Unit noting CGMP assigns the quality unit (QU) (defined in §210.3(b)(15)) responsibilities split between quality control (QC) (assessing suitability of components, containers, closures, labeling, in-process materials, finished products; evaluating manufacturing process performance for specification adherence; determining batch acceptability) and quality assurance (QA) (reviewing/approving production/maintenance procedures, reviewing records, auditing/trending), using “QU” for modern practice consistency, ensuring QU plans, approves, conducts, and monitors operations independently from manufacturing, development, and engineering units, with CGMP (§211.22) assigning QU authority to create, monitor, and implement QS, ensure controls during manufacturing, verify procedures/specifications are followed (including contractors), approve/reject materials/products, review records, investigate discrepancies, not substituting for manufacturing’s daily quality responsibility, allowing in limited cases one person for production and quality with additional periodic review by a qualified, independent individual; Subsection G—Six-system Inspection Model describing the FDA’s Drug Manufacturing Inspections Compliance Program (CPGM 7356.002) as a systems-based approach consistent with the QS model, including the quality system and five manufacturing systems (facilities/equipment, materials, production, packaging/labeling, laboratory controls), integrated into the QS model’s sections, assessing control states, used by CDER and CBER (blood products), with CBER and CVM developing it for drug products, emphasizing inter-relationships and control assessment; Section IV—The Quality Systems Model states its goal is to describe a model helping manufacturers comply with CGMP, requiring significant time/resources but offering long-term benefits, describing a robust QS model for consistent quality production with CGMP correlations, not recommending new requirements, focusing regulatory/inspectional coverage on CGMP, organized into four factors: Management Responsibilities, Resources, Manufacturing Operations, Evaluation Activities; Subsection A—Management Responsibilities detailing modern QS requiring management’s key role in design, implementation, and management; 1—Provide Leadership stating senior management should demonstrate commitment to QS development/maintenance, aligning QS plans with strategic plans, giving QS departments equal standing, integrating QS staff into manufacturing (e.g., nonconformance investigations), setting priorities, developing action plans, actively participating in design/implementation/monitoring (including system review), advocating continual improvement, committing resources, ensuring implementation across sites, encouraging communication among R&D, regulatory, manufacturing, and QU on quality issues, including management when appropriate; 2—Structure the Organization stating management must structure the organization, document it, ensure assigned authorities/responsibilities support production, quality, and management activities, communicate employee roles/responsibilities/authorities and interactions, appoint a senior manager to administer QS with authority to detect problems/implement solutions and provide prompt feedback; 3—Build Your Quality System to Meet Requirements recommending senior managers ensure QS design/implementation provides clear guidance and systematic evaluation for CGMP compliance (drug safety, identity, strength, quality, purity), addressing quality standard, scope (including outsourcing), policies/objectives, procedures, with formal change processes and secure, protected, archived record control (§211.22(c-d), §211.180(a-e)), requiring scientifically sound, appropriate, reviewed, approved, accessible written controls; 4—Establish Policies, Objectives, and Plans stating policies, objectives, and plans articulate senior management’s quality vision, requiring a mission with strong quality commitment, a communicated/understood/revised quality policy, objectives via formal quality planning aligned with strategic plans, resource support, measurable/monitored goals, documented/communicated plans aligning operational activities with strategic/quality goals; 5—Review the System stating review ensures QS suitability, adequacy, effectiveness, requiring senior managers to conduct scheduled performance reviews assessing policy, objectives, audits, feedback, trends, preventive actions, prior review follow-ups, business/environment changes, product needs, with frequent reviews for new systems, inclusion in general management meetings, optional external periodic reviews, recording outcomes for QS/manufacturing improvements, resource realignment, using effective CAPA/change control, with table of CGMP correlations: Leadership (none), Structure (§211.22(a), §211.180(f)), Build QS (§211.22(d), §§211.100(a), 211.160(a), §211.22(c), §211.22(a), §§211.42(c), 211.84(a), 211.87, 211.101(c)(1), 211.110(c), 211.115(b), 211.142, 211.165(d), 211.192, §§211.22(a), 211.100(a-b), 211.180(f), 211.192, 211.198(a), §§211.180(a-d), 211.186, 211.192, 211.194, 211.198(b)), Policies/Objectives/Plans (§§211.22(c-d), 211.100(a)), Review (§§211.100, 211.180(e), 211.192, 211.198(b)(2)); Subsection B—Resources stating appropriate resource allocation is key for robust QS and CGMP compliance; 1—General Arrangements requiring senior management/designee to provide adequate resources for facilities/equipment maintenance, suitable material acquisition, processing, and lab analysis (in-process, stability, reserve samples); 2—Personnel Development requiring a problem-solving/communicative culture, encouraging suggestions, cross-functional groups, qualified personnel for operations/risks (§211.25(a)), defined qualifications, QU personnel with scientific/technical/process/risk knowledge not taking other units’ roles, continued training on operations, CGMP, policies, processes, work culture, with needs evaluation, provision, effectiveness checks, documentation, verifying skill implementation; 3—Facilities and Equipment requiring technical experts (engineers, scientists) to define requirements based on science/risk/processes, QU to review/approve designs/changes (§211.22(b-c)), CGMP mandating qualified, calibrated, cleaned, maintained equipment to prevent contamination/mix-ups (§§211.63-68, 211.160), emphasizing process/testing equipment over typical QS focus on testing; 4—Control Outsourced Operations requiring contracts for operational processes (e.g., packaging, training) defining materials/services, quality specs, communication, ensuring contractor qualification, training, performance monitoring, compatible quality standards, contractor management familiarity with requirements, QU approval/rejection (§211.22(a)), with table of CGMP correlations: General Arrangements (none), Personnel (§211.25(a-c)), Facilities/Equipment (§§211.22(b), 211.28(c), 211.42-58, 211.173, §§211.63-72, 211.105, 211.160(b)(4), 211.182, §211.22(b)), Outsourcing (§§211.22(a), 211.34); Subsection C—Manufacturing noting significant CGMP overlap, tailoring to pharmaceuticals, with enforcement on CGMP; 1—Design, Develop, and Document Product and Processes requiring defined product characteristics from design to delivery, controlled changes (§211.100(a)), documented resources, procedures, process owners, variables, QC measures, validation (ranges, criteria), effects, responsibility for design/changes, with technical experts setting specs/parameters, planning packaging/labeling controls (Subpart G) before production with written procedures, quality activities, responsible positions, distinct labels; 2—Examine Inputs defining inputs as materials (components, containers, closures) purchased or produced, requiring reliability via testing or COA plus identity analysis (§211.84), validating reliability via tests against COA (1978 Preamble, comment 239), initial/periodic reassessment, trending acceptance/rejection data, auditing suppliers based on risk (observing tests, examining QS), combining analysis/audits, requiring specific identity tests (§211.84(d)(2)), procedures for qualified sources, in-house material acceptance, system design/maintenance/qualification/validation, change control (§211.100(a)), responding to supplier changes; 3—Perform and Monitor Operations requiring efficient validation/performance/monitoring (§211.100(a)), scientifically sound controls, meeting design/product objectives via specs/parameters, maturing design via experimentation, using risk management for scrutiny, scale-up studies, robust processes before production, knowledge transfer, conformance batches, continual improvement via QS, not a one-time validation, reviewing records for changes (§211.180), change control for improvements, written procedures with justified deviations (§211.100(b)), tracing history, critical process monitoring (§211.110, §211.188), validated systems, time limits (§211.111), in-process parameter controls, microbial prevention/validation (§211.113(b)), consistent parameters/acceptance (§211.110(b-c)), data for evaluation/improvement, monitoring/measuring/analyzing procedures, detecting variables, refining design, ensuring test accuracy, planning storage/shipment, trending via statistical process control, assessing capability; 4—Address Nonconformities requiring documented investigation/conclusion/follow-up (§211.192), measuring process/product attributes, handling discrepancies, defining responsibilities for halting/resuming, recording, investigating, remedial actions (correct nonconformity, authorize with justification, use alternately, reject), segregation, re-examination (§211.115), assessing significance for recurrence prevention, recalls (21 CFR Part 7), complaint investigations (§211.198), with table of CGMP correlations: Design (§211.100(a)), Inputs (§§210.3(b), 211.80-94, 211.101-122, 211.125), Operations (§§211.22(a-c), 211.100-113, 211.115(b), 211.160(a), 211.165(d), 211.188, §§211.22(a), 211.84(a), 211.87, 211.110(c)), Nonconformities (§§211.22(a), 211.100, 211.115, 211.192, 211.198, 21 CFR Part 7); Subsection D—Evaluation Activities noting close CGMP correlation; 1—Analyze Data for Trends requiring continual monitoring/improvement via data from monitoring, measurement, complaints, tracked over time, analyzing control effectiveness, trending more frequently than annual review (§211.180(e)) based on risk, detecting problems early, examining processes holistically; 2—Conduct Internal Audits requiring planned audits for QS implementation/maintenance, meeting parameters/specs, documented procedures considering risks, prior audits, complete system coverage, defining auditor training, responsibilities, scope, methodology, conduct (plans, meetings, interviews, reports), maintaining findings records, assigning follow-up, with managers resolving findings, verifying/recording actions, FDA refraining from reviewing audit reports (CPG 130.300); 3—Quality Risk Management requiring informed decision-making based on quality issues, patient safety, product availability, assessing probability/severity of harm, engaging stakeholders, implementing/evaluating controls, iterating as needed, aiding specs/parameters development, managing change; 4—Corrective Action requiring reactive improvement via documented procedures evaluating need, investigating root cause, determining/selecting/implementing action, evaluating effectiveness (§211.192), using nonconformance reports, returns, complaints, audits, data, management reviews; 5—Preventive Actions requiring proactive planning (succession, training, knowledge capture, change planning), identifying/assessing causes/consequences, evaluating/recording/monitoring actions, using data, risk analysis, scientific/regulatory updates; 6—Promote Improvement requiring QS effectiveness/efficiency improvement via these activities, with management evaluation, other activities as appropriate, with table of CGMP correlations: Trends (§211.180(e)), Audits (none), Risk (none), Corrective (§§211.22(a), 211.192), Preventive (none), Improvement (§211.110); Section V—Conclusion stating a comprehensive QS facilitates 21 CFR Parts 210 and 211 compliance for human/veterinary pharmaceuticals, including biologics, aiming for consistent safe/effective/sustainable production via science-based approaches, product use understanding, process weakness control, responsive deviation/investigation systems, risk assessment/reduction, well-defined processes/products from development through lifecycle, careful quality analysis, supportive management, benefiting manufacturing and business; Useful Reference Materials listing 25 sources: 1. 1978 Preamble (http://www.fda.gov/cder/dmpq/preamble.txt), 2. CPGM 7356.002 (http://www.fda.gov/cder/dmpq/compliance_guide.htm), 3. Juran/Gryna Quality Planning (1993), 4. ANSI/ISO/ASQ Q9000-2000, 5. Process Validation Guideline (1987, http://www.fda.gov/cder/guidance/pv.htm), 6. CPG 7132c.08 (2004, http://www.fda.gov/ora/compliance_ref/cpg/cpgdrg/cpg490-100.html), 7. Sterile Drug Products Guidance (2004), 8. CPG 130.300 (http://www.fda.gov/ora/compliance_ref/cpg/cpggenl/cpg130-300.html), 9. Baldrige Criteria (2003, http://baldrige.nist.gov/PDF_files/2003_Business_Criteria.pdf), 10. ANSI/ISO/ASQ Q9001-2000, 11. ANSI/ISO/ASQ Q9004-2000, 12. ANSI/ISO 17025-1999, 13. CMMI-SE/SW V1.1 (2002, http://www.sei.cmu.edu/pub/documents/02.reports/pdf/02tr002.pdf), 14. Balanced Scorecard (http://balancedscorecard.org), 15. EPA QA/G-1 (2002, http://www.epa.gov/quality/qs-docs/g1-final.pdf), 16. Q7A Guidance (2001), 17. WHO GMP (2003, http://www.who.int/medicines/library/qsm/trs908/trs908-4.pdf), 18. FDA Staff Manual 2350.1, 19. Managing Risks (1999, http://www.fda.gov/oc/tfrm/1999report.html), 20. Environmental Risk Framework (1997, http://www.riskworld.com/Nreports/1997/risk-rpt/pdf/EPAJAN.PDF), 21. FDA QS Framework Report (2003), 22. Clemson Tutorials (1995, http://deming.eng.clemson.edu/pub/tutorials/), 23. Thornton Variation Risk (2004), 24. Sterilization Validation Guidance (http://www.fda.gov/cder/guidance/cmc2.pdf), 25. Prince Pharmaceutical Quality Chapter (2004); Glossary defining Annual Review (annual evaluation of quality standards for spec/manufacturing/control changes), CAPA (corrective/preventive actions per 21 CFR 820.100), Continual Improvement (ongoing evaluation/positive change), Correction (repair/rework/adjustment of discrepancies), Corrective Action (eliminating existing discrepancy causes), Customer (product/service recipient), Discrepancy (outside expected range), Harm (health damage), Non-conformity (deficiency rendering quality unacceptable), Preventive Action (eliminating potential discrepancy causes), Product/Service (activity/process results), Quality (meeting customer needs), Quality Assurance (confidence in requirement fulfillment), Quality Control (ensuring product reproducibility), Quality Management (QS implementation accountability), Quality Objectives (measurable policy goals), Quality Plan (disseminated planning result), Quality Planning (setting objectives/processes/resources), Quality Policy (top-level quality intentions), Quality System (formalized practices for requirements/satisfaction/improvement), Quality Unit (group promoting quality), Risk (harm probability/severity), Risk Assessment (supporting risk decisions), Risk Management (applying quality policies to risk tasks), Senior Management (resource-mobilizing officials), Stakeholder (QS/business interest holder), Verification (evidence of requirement fulfillment), Validation (evidence of intended use fulfillment).
"""

def generate_response(query, history=None):
    model = "gemini-2.0-flash"
    
    # Create chat instance if history is provided
    if history:
        chat = client.chats.create(model=model)
        
        # Recreate chat history
        for message in history:
            if message["role"] == "user":
                chat.send_message(message["content"])
            # Skip assistant messages as they'll be generated when we send user messages
        
        # Stream the response to the latest message
        response_stream = chat.send_message_stream(query)
        full_response = ""
        
        for chunk in response_stream:
            chunk_text = chunk.text
            full_response += chunk_text
            yield chunk_text
            
        # Return the complete chat history including the new response
        updated_history = history.copy()
        updated_history.append({"role": "user", "content": query})
        updated_history.append({"role": "assistant", "content": full_response})
        return full_response, updated_history
    
    else:
        # For first-time queries with no history, use the system instruction and context
        system_instruction = f"""You are a helpful pharmaceutical regulation assistant specializing in 
        pharmaceutical CGMP Regulations. Provide clear, accurate information about regulatory requirements,
        quality systems, and compliance guidelines. Use conversational language while maintaining 
        technical accuracy. Base your answers on the following context:
        
        {LONG_CONTEXT}
        
        If you're unsure about something or if it's not covered in the context, acknowledge it rather than 
        providing potentially incorrect information."""
        
        generate_config = types.GenerateContentConfig(
            system_instruction=system_instruction,
            temperature=0.2,  # Lower temperature for more factual responses
            max_output_tokens=8000,  # Allow for comprehensive answers
        )
        
        contents = [query]
        
        # Stream response
        full_response = ""
        
        for chunk in client.models.generate_content_stream(
            model=model,
            contents=contents,
            config=generate_config,
        ):
            chunk_text = chunk.text
            full_response += chunk_text
            yield chunk_text
            
        # Create history for future use
        new_history = [
            {"role": "user", "content": query},
            {"role": "assistant", "content": full_response}
        ]
        
        return full_response, new_history

# Initialize session state for chat history
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []

# Streamlit app layout
st.title("Pharmaceutical Regulation Assistant")
st.write("Ask questions about CGMP Regulations and pharmaceutical quality systems.")

# Display chat history
for message in st.session_state.chat_history:
    role = message["role"]
    content = message["content"]
    
    if role == "user":
        st.chat_message("user").write(content)
    else:
        st.chat_message("assistant").write(content)

# User input using chat_input instead of text_input for better UX
user_query = st.chat_input("Ask a question about pharmaceutical regulations...")

if user_query:
    # Add user message to chat display
    st.chat_message("user").write(user_query)
    
    # Display assistant response with streaming
    with st.chat_message("assistant"):
        response_placeholder = st.empty()
        full_response = ""
        
        # Stream in the response
        response_container = st.container()
        
        if len(st.session_state.chat_history) > 0:
            # Use chat history for context
            response_generator = generate_response(user_query, st.session_state.chat_history)
        else:
            # First message
            response_generator = generate_response(user_query)
        
        for chunk in response_generator:
            if isinstance(chunk, tuple):
                # This is the final return value with the full response and history
                full_response, st.session_state.chat_history = chunk
                break
            else:
                # This is a text chunk
                full_response += chunk
                response_placeholder.write(full_response)
                
        # Ensure the final response is displayed
        response_placeholder.write(full_response)

# Add a clear conversation button
if st.button("Clear Conversation"):
    st.session_state.chat_history = []
    st.rerun()

if __name__ == "__main__":
    pass
